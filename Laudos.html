<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>Forescan - Visualizar Laudo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link href="css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/css/nice-select.min.css" integrity="sha256-mLBIhmBvigTFWPSCtvdu6a76T+3Xyt+K571hupeFLg4=" crossorigin="anonymous">
  <link href="css/style.css" rel="stylesheet">
  <link href="css/responsive.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="sub_page">
  <div class="hero_area">
    <header class="header_section">
      <div class="header_top">
        <div class="container">
          <div class="contact_nav">
            <a href="">
              <i class="fa fa-phone" aria-hidden="true"></i>
              <span>Ligue: (81) 99999-7632</span>
            </a>
            <a href="">
              <i class="fa fa-envelope" aria-hidden="true"></i>
              <span>Email: <span class="__cf_email__" data-cfemail="9af9f5f4eefbeef5dafcf5e8ffe9f9fbf4b4f9f5f7">[email protected]</span></span>
            </a>
            <a href="">
              <i class="fa fa-map-marker" aria-hidden="true"></i>
              <span>Recife - PE</span>
            </a>
          </div>
        </div>
      </div>
      <div class="header_bottom">
        <div class="container-fluid">
          <nav class="navbar navbar-expand-lg custom_nav-container">
            <a class="navbar-brand" href="index.html">
              <img src="images/Logo.png" alt="Forescan Logo">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
              <span class=""></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <div class="d-flex mr-auto flex-column flex-lg-row align-items-center">
                <ul class="navbar-nav">
                  <li class="nav-item">
                    <a class="nav-link" href="index.html">Dashboard</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="Adicionar_casos.html">Adicionar caso</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="Gerenciar_usuarios.html">Gerenciar Usuários</a>
                  </li>
                  <li class="nav-item active">
                    <a class="nav-link" href="Laudos.html">Visualizar Casos<span class="sr-only">(current)</span></a>
                  </li>
                </ul>
              </div>
              <div class="quote_btn-container">
                <form class="form-inline">
                  <button class="btn my-2 my-sm-0 nav_search-btn" type="submit">
                    <i class="fa fa-search" aria-hidden="true"></i>
                  </button>
                </form>
              </div>
            </div>
          </nav>
        </div>
      </div>
    </header>
  </div>

  <section class="layout_padding">
    <div class="container">
      <!-- Toast Container -->
      <div class="position-fixed top-0 end-0 p-3" style="z-index: 1050;">
        <div id="toastContainer"></div>
      </div>
      <h2 class="mb-4">Visualizar Caso</h2>
      <div class="card p-4 shadow-sm">
        <div class="row">
          <div class="col-md-6">
            <h5>Nome do Caso</h5>
            <p id="laudoNomeCaso">N/A</p>
          </div>
          <div class="col-md-6">
            <h5>Data da Perícia</h5>
            <p id="laudoData">N/A</p>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6">
            <h5>Status do Caso</h5>
            <p>
              <span id="laudoStatus">N/A</span>
              <a href="#" id="alterarStatusLink" class="ms-2 text-primary" data-bs-toggle="modal" data-bs-target="#statusModal" style="display: none;">Alterar Status</a>
            </p>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6">
            <h5>Nome do Perito</h5>
            <p id="laudoPerito">N/A</p>
          </div>
        </div>
        <div class="mt-4">
          <h5>Detalhe do Caso</h5>
          <p id="laudoDescricao">N/A</p>
        </div>
        <div class="mt-4">
          <h5>Evidência</h5>
          <p id="laudoDiagnostico">N/A</p>
        </div>
        <div class="mt-4">
          <h5>Observações Adicionais</h5>
          <p id="laudoObservacoes">Nenhuma</p>
        </div>
        <div class="mt-4">
          <h5>Fotos</h5>
          <div id="laudoFotos" class="owl-carousel team_carousel">
            <p>Nenhuma foto disponível</p>
          </div>
        </div>
        <div class="mt-4 d-flex gap-2">
          <a href="index.html" class="btn btn-black">Voltar ao Dashboard</a>
          <a id="editarBtn" href="#" class="btn btn-primary">Editar Laudo</a>
          <button id="excluirBtn" class="btn btn-danger" onclick="excluirCaso()">Excluir Laudo</button>
        </div>
      </div>

      <!-- Modal para Atualizar Status -->
      <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="statusModalLabel">Atualizar Status do Caso</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <label for="statusSelect" class="form-label">Novo Status</label>
              <br>
              <select class="form-select" id="statusSelect">
                <option value="Em andamento">Em andamento</option>
                <option value="Finalizado">Finalizado</option>
                <option value="Arquivado">Arquivado</option>
              </select>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" id="salvarStatusBtn">Salvar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="info_section">
    <div class="container">
      <div class="info_top">
 
        <div class="info_form">
          <form action="">
            <input type="email" placeholder="Seu email">
            <button>Inscrever-se</button>
          </form>
        </div>
      </div>
      <div class="info_bottom layout_padding2">
        <div class="row info_main_row">
          <div class="col-md-6 col-lg-3">
            <h5>Endereço</h5>
            <div class="info_contact">
              <a href="">
                <i class="fa fa-map-marker" aria-hidden="true"></i>
                <span>Recife - PE</span>
              </a>
              <a href="">
                <i class="fa fa-phone" aria-hidden="true"></i>
                <span>Ligue (81) 99999-7632</span>
              </a>
              <a href="">
                <i class="fa fa-envelope"></i>
                <span><span class="__cf_email__" data-cfemail="afccc0c1dbcedbc0efcdc4d9ced8c8c6c981ccc0c2">[email protected]</span></span>
              </a>
            </div>
            <div class="social_box">
              <a href=""><i class="fa fa-facebook" aria-hidden="true"></i></a>
              <a href=""><i class="fa fa-twitter" aria-hidden="true"></i></a>
              <a href=""><i class="fa fa-linkedin" aria-hidden="true"></i></a>
              <a href=""><i class="fa fa-instagram" aria-hidden="true"></i></a>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="info_links">
              <h5>Links Úteis</h5>
              <div class="info_links_menu">
                <a href="index.html">Dashboard</a>
                <a href="Adicionar_casos.html">Adicionar casos</a>
                <a href="Gerenciar_usuarios.html">Gerenciar Usuários</a>
                <a href="Login.html">Login</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  <footer class="footer_section">
    <div class="container">
      <p>© <span id="displayYear"></span></p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/idb@7.0.0/build/umd.js"></script>
  <script src="js/jquery-3.4.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/js/jquery.nice-select.min.js" integrity="sha256-Zr3vByTlMGQhvMfgkQ5BtWRSKBGa2QlspKYJnkjZTmo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
  <script src="js/custom.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const dbPromise = idb.openDB('forescanDB', 1, {
        upgrade(db) {
          if (!db.objectStoreNames.contains('laudos')) {
            db.createObjectStore('laudos', { keyPath: 'id' });
          }
        }
      });

      // Recuperar o ID do caso da URL
      const casoId = new URLSearchParams(window.location.search).get('id');
      if (!casoId) {
        mostrarToast('Nenhum caso especificado para visualização.', 'danger');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1000);
        return;
      }

      // Carregar o caso do IndexedDB
      let caso;
      try {
        const db = await dbPromise;
        caso = await db.get('laudos', casoId);
        if (!caso) {
          mostrarToast('Caso não encontrado.', 'danger');
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 1000);
          return;
        }

        // Preencher os campos com os dados do caso
        document.getElementById('laudoNomeCaso').textContent = caso.nomeCaso || 'N/A';
        document.getElementById('laudoData').textContent = caso.data || 'N/A';
        document.getElementById('laudoPerito').textContent = caso.perito || 'N/A';
        document.getElementById('laudoStatus').textContent = caso.status || 'Em andamento';
        document.getElementById('laudoDescricao').textContent = caso.descricao || 'N/A';
        document.getElementById('laudoDiagnostico').textContent = caso.diagnostico || 'N/A';
        document.getElementById('laudoObservacoes').textContent = caso.observacoes || 'Nenhuma';

        // Configurar o link do botão "Editar"
        const editarBtn = document.getElementById('editarBtn');
        editarBtn.href = `Adicionar_casos.html?id=${casoId}`;

        // Configurar o botão "Excluir" para usar a função do custom.js
        const excluirBtn = document.getElementById('excluirBtn');
        excluirBtn.setAttribute('onclick', `excluirCaso('${casoId}')`);

        // Configurar o select de status no modal
        const statusSelect = document.getElementById('statusSelect');
        statusSelect.value = caso.status || 'Em andamento';
        $('#statusSelect').niceSelect('update');

        // Controlar a visibilidade do link "Alterar Status" com base no tipo de usuário
        const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
        const alterarStatusLink = document.getElementById('alterarStatusLink');
        if (usuarioLogado && (usuarioLogado.tipo === 'Administrador' || usuarioLogado.tipo === 'Perito')) {
          alterarStatusLink.style.display = 'inline';
        } else {
          alterarStatusLink.style.display = 'none';
        }

        // Evento para salvar o status a partir do modal
        const salvarStatusBtn = document.getElementById('salvarStatusBtn');
        salvarStatusBtn.addEventListener('click', async () => {
          const newStatus = statusSelect.value;
          try {
            const db = await dbPromise;
            caso.status = newStatus;
            await db.put('laudos', caso);
            document.getElementById('laudoStatus').textContent = newStatus;
            mostrarToast('Status atualizado com sucesso!', 'success');
            $('#statusModal').modal('hide');
          } catch (err) {
            console.error('Erro ao atualizar status:', err);
            mostrarToast('Erro ao atualizar o status.', 'danger');
          }
        });

        // Carregar as fotos no carrossel
        const laudoFotos = document.getElementById('laudoFotos');
        if (caso.fotos && caso.fotos.length > 0) {
          laudoFotos.innerHTML = '';
          caso.fotos.forEach((foto, index) => {
            const item = document.createElement('div');
            item.className = 'item';
            item.innerHTML = `
              <div class="box">
                <div class="img-box">
                  <img src="${foto}" alt="Foto ${index + 1}" style="max-width: 100%; height: auto;" />
                </div>
              </div>
            `;
            laudoFotos.appendChild(item);
          });

          // Inicializar o carrossel
          $(laudoFotos).owlCarousel({
            loop: caso.fotos.length > 1,
            margin: 15,
            dots: true,
            autoplay: true,
            navText: [
              '<i class="fa fa-angle-left" aria-hidden="true"></i>',
              '<i class="fa fa-angle-right" aria-hidden="true"></i>'
            ],
            autoplayHoverPause: true,
            responsive: {
              0: { items: 1, margin: 0 },
              576: { items: 2 },
              992: { items: 3 }
            }
          });
        } else {
          laudoFotos.innerHTML = '<p>Nenhuma foto disponível</p>';
        }

        // Controlar a visibilidade dos botões com base no tipo de usuário
        if (usuarioLogado) {
          const tipoUsuario = usuarioLogado.tipo;
          if (tipoUsuario === 'Assistente') {
            editarBtn.style.display = 'none';
            excluirBtn.style.display = 'none';
            console.log('Usuário Assistente: botões Editar e Excluir ocultados.');
          } else if (tipoUsuario === 'Perito') {
            excluirBtn.style.display = 'none';
            console.log('Usuário Perito: botão Excluir ocultado.');
          } else if (tipoUsuario === 'Administrador') {
            console.log('Usuário Administrador: todos os botões visíveis.');
          }
        } else {
          console.log('Nenhum usuário logado encontrado.');
        }
      } catch (err) {
        console.error('Erro ao carregar caso do IndexedDB:', err);
        mostrarToast('Erro ao carregar o caso. Tente novamente.', 'danger');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1000);
        return;
      }
    });
  
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9342d038ec137b98',t:'MTc0NTMwMDcwOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
